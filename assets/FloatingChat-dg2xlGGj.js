import{r as s,j as t}from"./index-CoPCSzxc.js";const ne="_container_13a2w_1",ae="_bottomRight_13a2w_11",oe="_bottomLeft_13a2w_16",re="_toggleButton_13a2w_21",le="_toggleIcon_13a2w_51",ce="_panel_13a2w_55",ie="_open_13a2w_74",ue="_header_13a2w_85",de="_title_13a2w_95",he="_closeButton_13a2w_101",me="_messages_13a2w_116",ge="_message_13a2w_116",fe="_messageBody_13a2w_135",_e="_user_13a2w_171",xe="_bot_13a2w_11",pe="_sources_13a2w_185",be="_sourcesLabel_13a2w_190",we="_typing_13a2w_207",ye="_form_13a2w_213",je="_textarea_13a2w_223",$e="_actions_13a2w_246",ve="_error_13a2w_253",Ee="_retryButton_13a2w_261",Ne="_sendButton_13a2w_276",Ce="_visuallyHidden_13a2w_300",n={container:ne,bottomRight:ae,bottomLeft:oe,toggleButton:re,toggleIcon:le,panel:ce,open:ie,header:ue,title:de,closeButton:he,messages:me,message:ge,messageBody:fe,user:_e,bot:xe,sources:pe,sourcesLabel:be,typing:we,form:ye,textarea:je,actions:$e,error:ve,retryButton:Ee,sendButton:Ne,visuallyHidden:Ce},Ie="#24A0ED",Be="https://bot-farmacia-vivomas.onrender.com/chat",Re=56,Le=/(\*\*[^*]+\*\*|\*[^*]+\*|_[^_]+_|`[^`]+`|\[[^\]]+\]\([^)]+\))/g,$=(c,e)=>{const o=[];let i=0,u;const h=new RegExp(Le.source,"g");for(;(u=h.exec(c))!==null;){const{index:g}=u;g>i&&o.push(c.slice(i,g));const a=u[0],l=o.length;if(a.startsWith("**"))o.push(t.jsx("strong",{children:$(a.slice(2,-2),`${e}-b-${l}`)},`${e}-b-${l}`));else if(a.startsWith("*"))o.push(t.jsx("em",{children:$(a.slice(1,-1),`${e}-em-${l}`)},`${e}-em-${l}`));else if(a.startsWith("_"))o.push(t.jsx("em",{children:$(a.slice(1,-1),`${e}-em-${l}`)},`${e}-em-${l}`));else if(a.startsWith("`"))o.push(t.jsx("code",{children:a.slice(1,-1)},`${e}-code-${l}`));else if(a.startsWith("[")){const p=a.indexOf("]"),y=a.indexOf("(",p),E=a.lastIndexOf(")"),N=a.slice(1,p),C=a.slice(y+1,E);o.push(t.jsx("a",{href:C,target:"_blank",rel:"noopener noreferrer",children:$(N,`${e}-link-${l}`)},`${e}-link-${l}`))}i=h.lastIndex}return i<c.length&&o.push(c.slice(i)),o},Se=(c,e)=>{const o=c.split(/\r?\n/),i=[];let u=[];const h=()=>{u.length>0&&(i.push(t.jsx("ul",{children:u},`${e}-list-${i.length}`)),u=[])};return o.forEach((g,a)=>{const l=g.trim();if(!l){h();return}const p=/^[-*•]\s+(.*)$/.exec(l);if(p){const y=p[1];u.push(t.jsx("li",{children:$(y,`${e}-li-${a}`)},`${e}-li-${a}`));return}h(),i.push(t.jsx("p",{children:$(l,`${e}-p-${a}`)},`${e}-p-${a}`))}),h(),t.jsx(t.Fragment,{children:i.map((g,a)=>t.jsx(s.Fragment,{children:g},`${e}-el-${a}`))})},Me=()=>{if(!(typeof window>"u"))return window.crypto||window.msCrypto},M=()=>{const c=Me();if(c?.getRandomValues){const e=new Uint8Array(16);c.getRandomValues(e),e[6]=e[6]&15|64,e[8]=e[8]&63|128;const o=[e.subarray(0,4),e.subarray(4,6),e.subarray(6,8),e.subarray(8,10),e.subarray(10,16)].map(i=>Array.from(i).map(u=>u.toString(16).padStart(2,"0")).join(""));return[o[0],o[1],o[2],o[3],o[4]].join("-")}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const o=Math.random()*16;return((e==="x"?o:o&3|8)|0).toString(16)})},ke=c=>Array.isArray(c)?c.map((e,o)=>{if(typeof e=="string")return{title:e};if(e&&typeof e=="object")return{title:e.title??`Fuente ${o+1}`,url:e.url}}).filter(e=>!!e):[],Te=({primaryColor:c=Ie,position:e="bottom-right",zIndex:o=40,placeholder:i="Escribe tu mensaje…",endpoint:u=Be,initialOpen:h=!1,offsetX:g,offsetY:a,onOpen:l,onClose:p,onSessionStart:y,onSend:E,onResponse:N,onError:C})=>{const[m,k]=s.useState(h),[f,Z]=s.useState(null),[A,T]=s.useState([]),[b,I]=s.useState(""),[_,D]=s.useState(!1),[F,R]=s.useState(null),L=s.useRef(null),O=s.useRef(null),V=s.useRef(null),B=s.useCallback(()=>{Z(r=>{if(r)return r;const d=M();return y?.(d),d})},[y]),H=s.useCallback(()=>{k(!0),B(),l?.()},[B,l]),v=s.useCallback(()=>{k(!1),I(""),R(null),p?.()},[p]),j=s.useCallback(async(r,d)=>{if(!f)return;const w=r.trim();if(w){D(!0),R(null),d&&T(x=>[...x,{id:M(),role:"user",content:w}]),L.current=w,E?.(w,f);try{const x=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:w,session_id:f})});if(!x.ok)throw new Error(`Request failed with status ${x.status}`);const W=await x.json(),G=W.answer??"",te=ke(W.sources);T(se=>[...se,{id:M(),role:"bot",content:G,sources:te}]),N?.(G)}catch(x){R("No pudimos procesar tu mensaje. Intenta nuevamente."),C?.(x)}finally{D(!1)}}},[u,C,N,E,f]),q=s.useCallback(()=>{m?v():H()},[v,m,H]),z=s.useCallback(async r=>{if(r.preventDefault(),!f||_)return;const d=b;I(""),await j(d,!0)},[b,_,j,f]),J=s.useCallback(async()=>{!L.current||!f||_||await j(L.current,!1)},[_,j,f]),Q=s.useCallback(r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),!_&&f&&b.trim()&&(j(b,!0),I("")))},[b,_,j,f]);s.useEffect(()=>{h&&B()},[B,h]),s.useEffect(()=>{h&&l?.()},[h,l]),s.useEffect(()=>{m&&O.current?.focus()},[m]),s.useEffect(()=>{m&&V.current?.scrollIntoView({behavior:"smooth",block:"end"})},[m,_,A]),s.useEffect(()=>{if(!m)return;const r=d=>{d.key==="Escape"&&v()};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[v,m]);const X=s.useCallback(r=>{I(r.target.value)},[]),U=s.useMemo(()=>typeof g=="number"?`${g}px`:g,[g]),K=s.useMemo(()=>typeof a=="number"?`${a}px`:a,[a]),Y=s.useMemo(()=>({zIndex:o,"--floating-chat-primary":c,"--floating-chat-offset-x":U,"--floating-chat-offset-y":K,"--floating-chat-toggle-size":`${Re}px`}),[c,U,K,o]),S=s.useMemo(()=>({backgroundColor:c}),[c]),P=S,ee=`${n.container} ${e==="bottom-left"?n.bottomLeft:n.bottomRight}`;return t.jsxs("div",{className:ee,style:Y,children:[t.jsx("button",{type:"button",className:n.toggleButton,style:S,onClick:q,"data-floating-chat-toggle":"true","aria-expanded":m,"aria-controls":"floating-chat-panel","aria-label":m?"Cerrar chat":"Abrir chat",children:t.jsx("svg",{className:n.toggleIcon,width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:t.jsx("path",{d:"M20 2H4C2.895 2 2 2.895 2 4V18C2 19.105 2.895 20 4 20H18L22 24V4C22 2.895 21.105 2 20 2Z",fill:"currentColor"})})}),t.jsxs("div",{id:"floating-chat-panel",role:"dialog","aria-label":"Chat de asistencia","aria-modal":"false","aria-hidden":!m,className:`${n.panel} ${m?n.open:""}`,children:[t.jsxs("header",{className:n.header,style:P,children:[t.jsx("h2",{className:n.title,children:"Agente IA Vivo Más"}),t.jsx("button",{type:"button",className:n.closeButton,onClick:v,"aria-label":"Cerrar",children:"×"})]}),t.jsxs("div",{className:n.messages,role:"log","aria-live":"polite",children:[A.map(r=>t.jsxs("div",{className:`${n.message} ${r.role==="bot"?n.bot:n.user}`,children:[t.jsx("div",{className:n.messageBody,children:Se(r.content,r.id)}),r.sources&&r.sources.length>0&&t.jsxs("div",{className:n.sources,children:[t.jsx("span",{className:n.sourcesLabel,children:"Fuentes:"}),t.jsx("ul",{children:r.sources.map((d,w)=>{const x=`${r.id}-source-${w}`;return t.jsx("li",{children:d.url?t.jsx("a",{href:d.url,target:"_blank",rel:"noopener noreferrer",children:d.title}):d.title},x)})})]})]},r.id)),_&&t.jsx("div",{className:`${n.message} ${n.bot}`,children:t.jsx("p",{className:n.typing,children:"El asistente está respondiendo…"})}),t.jsx("div",{ref:V})]}),t.jsxs("form",{className:n.form,onSubmit:z,children:[t.jsx("label",{htmlFor:"floating-chat-input",className:n.visuallyHidden,children:i}),t.jsx("textarea",{id:"floating-chat-input",ref:O,className:n.textarea,placeholder:i,value:b,onChange:X,onKeyDown:Q,disabled:_,rows:2}),t.jsxs("div",{className:n.actions,children:[F&&t.jsxs("div",{className:n.error,role:"alert",children:[t.jsx("span",{children:F}),t.jsx("button",{type:"button",onClick:J,className:n.retryButton,children:"Reintentar"})]}),t.jsx("button",{type:"submit",className:n.sendButton,style:S,disabled:_||!f||!b.trim(),children:"Enviar"})]})]})]})]})};export{Te as FloatingChat,Te as default};
