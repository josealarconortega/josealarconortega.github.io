import{r as n,j as t}from"./index-Cd1GoFaO.js";const oe="_container_6lbh2_1",ae="_bottomRight_6lbh2_11",le="_bottomLeft_6lbh2_16",re="_toggleButton_6lbh2_21",ce="_toggleEmoji_6lbh2_52",ie="_toggleCopy_6lbh2_57",ue="_toggleLabel_6lbh2_64",de="_toggleTitle_6lbh2_72",he="_panel_6lbh2_103",ge="_open_6lbh2_122",me="_header_6lbh2_133",be="_title_6lbh2_143",_e="_closeButton_6lbh2_149",fe="_messages_6lbh2_164",pe="_message_6lbh2_164",xe="_messageBody_6lbh2_183",ye="_user_6lbh2_219",je="_bot_6lbh2_11",$e="_sources_6lbh2_233",Ee="_sourcesLabel_6lbh2_238",ve="_typing_6lbh2_255",we="_form_6lbh2_261",Ne="_textarea_6lbh2_271",Ce="_actions_6lbh2_294",Le="_error_6lbh2_301",Re="_retryButton_6lbh2_309",Be="_sendButton_6lbh2_324",Ie="_visuallyHidden_6lbh2_348",s={container:oe,bottomRight:ae,bottomLeft:le,toggleButton:re,toggleEmoji:ce,toggleCopy:ie,toggleLabel:ue,toggleTitle:de,panel:he,open:ge,header:me,title:be,closeButton:_e,messages:fe,message:pe,messageBody:xe,user:ye,bot:je,sources:$e,sourcesLabel:Ee,typing:ve,form:we,textarea:Ne,actions:Ce,error:Le,retryButton:Re,sendButton:Be,visuallyHidden:Ie},Se="#24A0ED",Te="https://bot-farmacia-vivomas.onrender.com/chat",Ae=56,q="floating-chat-open",Me=/(\*\*[^*]+\*\*|\*[^*]+\*|_[^_]+_|`[^`]+`|\[[^\]]+\]\([^)]+\))/g,E=(c,e)=>{const l=[];let i=0,d;const h=new RegExp(Me.source,"g");for(;(d=h.exec(c))!==null;){const{index:b}=d;b>i&&l.push(c.slice(i,b));const a=d[0],r=l.length;if(a.startsWith("**"))l.push(t.jsx("strong",{children:E(a.slice(2,-2),`${e}-b-${r}`)},`${e}-b-${r}`));else if(a.startsWith("*"))l.push(t.jsx("em",{children:E(a.slice(1,-1),`${e}-em-${r}`)},`${e}-em-${r}`));else if(a.startsWith("_"))l.push(t.jsx("em",{children:E(a.slice(1,-1),`${e}-em-${r}`)},`${e}-em-${r}`));else if(a.startsWith("`"))l.push(t.jsx("code",{children:a.slice(1,-1)},`${e}-code-${r}`));else if(a.startsWith("[")){const x=a.indexOf("]"),j=a.indexOf("(",x),N=a.lastIndexOf(")"),C=a.slice(1,x),L=a.slice(j+1,N);l.push(t.jsx("a",{href:L,target:"_blank",rel:"noopener noreferrer",children:E(C,`${e}-link-${r}`)},`${e}-link-${r}`))}i=h.lastIndex}return i<c.length&&l.push(c.slice(i)),l},ke=(c,e)=>{const l=c.split(/\r?\n/),i=[];let d=[];const h=()=>{d.length>0&&(i.push(t.jsx("ul",{children:d},`${e}-list-${i.length}`)),d=[])};return l.forEach((b,a)=>{const r=b.trim();if(!r){h();return}const x=/^[-*‚Ä¢]\s+(.*)$/.exec(r);if(x){const j=x[1];d.push(t.jsx("li",{children:E(j,`${e}-li-${a}`)},`${e}-li-${a}`));return}h(),i.push(t.jsx("p",{children:E(r,`${e}-p-${a}`)},`${e}-p-${a}`))}),h(),t.jsx(t.Fragment,{children:i.map((b,a)=>t.jsx(n.Fragment,{children:b},`${e}-el-${a}`))})},De=()=>{if(!(typeof window>"u"))return window.crypto||window.msCrypto},M=()=>{const c=De();if(c?.getRandomValues){const e=new Uint8Array(16);c.getRandomValues(e),e[6]=e[6]&15|64,e[8]=e[8]&63|128;const l=[e.subarray(0,4),e.subarray(4,6),e.subarray(6,8),e.subarray(8,10),e.subarray(10,16)].map(i=>Array.from(i).map(d=>d.toString(16).padStart(2,"0")).join(""));return[l[0],l[1],l[2],l[3],l[4]].join("-")}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const l=Math.random()*16;return((e==="x"?l:l&3|8)|0).toString(16)})},Fe=c=>Array.isArray(c)?c.map((e,l)=>{if(typeof e=="string")return{title:e};if(e&&typeof e=="object")return{title:e.title??`Fuente ${l+1}`,url:e.url}}).filter(e=>!!e):[],Ve=({primaryColor:c=Se,position:e="bottom-right",zIndex:l=40,placeholder:i="Escribe tu mensaje‚Ä¶",endpoint:d=Te,initialOpen:h=!1,offsetX:b,offsetY:a,onOpen:r,onClose:x,onSessionStart:j,onSend:N,onResponse:C,onError:L})=>{const[g,k]=n.useState(h),[_,z]=n.useState(null),[D,F]=n.useState([]),[y,v]=n.useState(""),[f,O]=n.useState(!1),[V,S]=n.useState(null),T=n.useRef(null),R=n.useRef(null),U=n.useRef(null),B=n.useCallback(()=>{z(o=>{if(o)return o;const u=M();return j?.(u),u})},[j]),I=n.useCallback(()=>{k(!0),B(),r?.()},[B,r]),w=n.useCallback(()=>{k(!1),v(""),S(null),x?.()},[x]),$=n.useCallback(async(o,u)=>{if(!_)return;const m=o.trim();if(m){O(!0),S(null),u&&F(p=>[...p,{id:M(),role:"user",content:m}]),T.current=m,N?.(m,_);try{const p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:m,session_id:_})});if(!p.ok)throw new Error(`Request failed with status ${p.status}`);const H=await p.json(),G=H.answer??"",se=Fe(H.sources);F(ne=>[...ne,{id:M(),role:"bot",content:G,sources:se}]),C?.(G)}catch(p){S("No pudimos procesar tu mensaje. Intenta nuevamente."),L?.(p)}finally{O(!1)}}},[d,L,C,N,_]),J=n.useCallback(()=>{g?w():I()},[w,g,I]),Z=n.useCallback(async o=>{if(o.preventDefault(),!_||f)return;const u=y;v(""),await $(u,!0)},[y,f,$,_]),Q=n.useCallback(async()=>{!T.current||!_||f||await $(T.current,!1)},[f,$,_]),X=n.useCallback(o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),!f&&_&&y.trim()&&($(y,!0),v("")))},[y,f,$,_]);n.useEffect(()=>{h&&B()},[B,h]),n.useEffect(()=>{h&&r?.()},[h,r]),n.useEffect(()=>{if(typeof window>"u")return;const o=u=>{const{presetMessage:m}=u.detail??{};I(),m&&(v(m),requestAnimationFrame(()=>{R.current?.focus(),R.current?.setSelectionRange(m.length,m.length)}))};return window.addEventListener(q,o),()=>{window.removeEventListener(q,o)}},[I]),n.useEffect(()=>{g&&R.current?.focus()},[g]),n.useEffect(()=>{g&&U.current?.scrollIntoView({behavior:"smooth",block:"end"})},[g,f,D]),n.useEffect(()=>{if(!g)return;const o=u=>{u.key==="Escape"&&w()};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[w,g]);const Y=n.useCallback(o=>{v(o.target.value)},[]),K=n.useMemo(()=>typeof b=="number"?`${b}px`:b,[b]),W=n.useMemo(()=>typeof a=="number"?`${a}px`:a,[a]),P=n.useMemo(()=>({zIndex:l,"--floating-chat-primary":c,"--floating-chat-offset-x":K,"--floating-chat-offset-y":W,"--floating-chat-toggle-size":`${Ae}px`}),[c,K,W,l]),A=n.useMemo(()=>({backgroundColor:c}),[c]),ee=A,te=`${s.container} ${e==="bottom-left"?s.bottomLeft:s.bottomRight}`;return t.jsxs("div",{className:te,style:P,children:[t.jsxs("button",{type:"button",className:s.toggleButton,style:A,onClick:J,"data-floating-chat-toggle":"true","aria-expanded":g,"aria-controls":"floating-chat-panel","aria-label":g?"Cerrar chat":"Abrir chat",children:[t.jsx("span",{className:s.toggleEmoji,"aria-hidden":"true",children:"ü§ñ"}),t.jsxs("span",{className:s.toggleCopy,"aria-hidden":"true",children:[t.jsx("span",{className:s.toggleLabel,children:"Asistente IA"}),t.jsx("span",{className:s.toggleTitle,children:"Vivo M√°s"})]})]}),t.jsxs("div",{id:"floating-chat-panel",role:"dialog","aria-label":"Chat de asistencia","aria-modal":"false","aria-hidden":!g,className:`${s.panel} ${g?s.open:""}`,children:[t.jsxs("header",{className:s.header,style:ee,children:[t.jsx("h2",{className:s.title,children:"Agente IA Vivo M√°s"}),t.jsx("button",{type:"button",className:s.closeButton,onClick:w,"aria-label":"Cerrar",children:"√ó"})]}),t.jsxs("div",{className:s.messages,role:"log","aria-live":"polite",children:[D.map(o=>t.jsxs("div",{className:`${s.message} ${o.role==="bot"?s.bot:s.user}`,children:[t.jsx("div",{className:s.messageBody,children:ke(o.content,o.id)}),o.sources&&o.sources.length>0&&t.jsxs("div",{className:s.sources,children:[t.jsx("span",{className:s.sourcesLabel,children:"Fuentes:"}),t.jsx("ul",{children:o.sources.map((u,m)=>{const p=`${o.id}-source-${m}`;return t.jsx("li",{children:u.url?t.jsx("a",{href:u.url,target:"_blank",rel:"noopener noreferrer",children:u.title}):u.title},p)})})]})]},o.id)),f&&t.jsx("div",{className:`${s.message} ${s.bot}`,children:t.jsx("p",{className:s.typing,children:"El asistente est√° respondiendo‚Ä¶"})}),t.jsx("div",{ref:U})]}),t.jsxs("form",{className:s.form,onSubmit:Z,children:[t.jsx("label",{htmlFor:"floating-chat-input",className:s.visuallyHidden,children:i}),t.jsx("textarea",{id:"floating-chat-input",ref:R,className:s.textarea,placeholder:i,value:y,onChange:Y,onKeyDown:X,disabled:f,rows:2}),t.jsxs("div",{className:s.actions,children:[V&&t.jsxs("div",{className:s.error,role:"alert",children:[t.jsx("span",{children:V}),t.jsx("button",{type:"button",onClick:Q,className:s.retryButton,children:"Reintentar"})]}),t.jsx("button",{type:"submit",className:s.sendButton,style:A,disabled:f||!_||!y.trim(),children:"Enviar"})]})]})]})]})};export{Ve as FloatingChat,Ve as default};
